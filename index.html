<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rogue Word Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Lexend+Mega&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lexend Mega', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            overflow: hidden; /* Prevent scrollbars from appearing during animation */
        }
        .font-pixel {
            font-family: 'Press Start 2P', cursive;
        }
        .letter-tile {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            border-bottom: 4px solid #4a5568;
        }
        .letter-tile:hover {
            transform: translateY(-4px) scale(1.05);
            background-color: #4a5568;
        }
        .letter-tile.selected {
            transform: translateY(-2px) scale(0.95);
            background-color: #f56565;
            color: #1a202c;
            border-bottom-color: #c53030;
            opacity: 0.5;
        }
        .letter-tile.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        .letter-tile.golden {
            background-color: #f6e05e;
            color: #422006;
            border-bottom-color: #d69e2e;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 10px #f6e05e; }
            50% { transform: scale(1.05); box-shadow: 0 0 20px #f6e05e, 0 0 30px #f6e05e; }
        }
        .btn {
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:active { transform: translateY(1px); }
        #xp-bar-fill { transition: width 0.5s ease-in-out; }
        #upgrade-modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        .upgrade-card {
            transition: all 0.2s ease-in-out;
            border-bottom: 4px solid #4a5568;
        }
        .upgrade-card:hover { transform: translateY(-8px); border-bottom-color: #63b3ed; }

        /* New styles for flying letter animation */
        .flying-letter {
            position: absolute;
            background-color: #4a5568;
            color: #e2e8f0;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 100;
            transition: all 0.4s cubic-bezier(0.5, 0, 0.75, 0); /* Ease-in curve */
            pointer-events: none;
        }

        /* New styles for the word display slots */
        .word-slot {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 4rem;
            height: 4rem;
            background-color: #2d3748;
            border-bottom: 2px solid #4a5568;
            margin: 0 0.25rem;
            border-radius: 0.5rem;
            color: transparent;
            transition: color 0.3s ease;
        }
        .word-slot.filled {
            color: #e2e8f0;
            background-color: #4a5568;
        }
        
        /* New styles for the upgrades panel */
        .upgrade-info-card {
            background-color: #2d3748;
            padding: 1rem;
            border-radius: 0.75rem;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="w-full mx-auto flex flex-col md:flex-row gap-8" style="max-width: 1024px;">

        <!-- Left Column: Upgrades Panel -->
        <div class="w-full md:w-1/3 bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-2xl border border-gray-700 flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                 <h3 class="font-pixel text-xl text-purple-300">ACTIVE UPGRADES</h3>
            </div>
            <div id="upgrades-panel" class="flex-grow flex flex-col gap-3 overflow-y-auto pr-2">
                <p id="no-upgrades-text" class="text-gray-400">No upgrades yet. Level up to earn them!</p>
            </div>
        </div>

        <!-- Right Column: Game -->
        <div class="w-full md:w-2/3">
            <main id="game-container" class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-2xl border border-gray-700">
                <!-- Stats Bar -->
                <div class="flex justify-between items-center mb-4 text-lg flex-wrap gap-4">
                    <div>
                        <span class="font-pixel text-blue-300">SCORE:</span>
                        <span id="score" class="font-bold text-2xl ml-2">0</span>
                    </div>
                    <div>
                        <span class="font-pixel text-green-300">LEVEL:</span>
                        <span id="level" class="font-bold text-2xl ml-2">1</span>
                    </div>
                </div>

                <!-- XP Bar -->
                <div class="mb-4">
                    <div class="w-full bg-gray-700 rounded-full h-6 border-2 border-gray-600">
                        <div id="xp-bar-fill" class="bg-purple-500 h-full rounded-full text-white text-sm leading-6 flex items-center justify-center" style="width: 0%;">
                            <span id="xp-text" class="whitespace-nowrap">0 / 100</span>
                        </div>
                    </div>
                </div>

                <!-- Current Word Display -->
                <div id="current-word-display" class="h-20 bg-gray-900 rounded-lg mb-4 flex items-center justify-center text-3xl tracking-widest font-bold border-2 border-gray-700">
                    <!-- Word slots will be generated by JS -->
                </div>

                <!-- Grid is 5x5 -->
                <div id="grid-container" class="grid grid-cols-5 gap-2 sm:gap-3 mb-4"></div>

                <!-- Action Buttons -->
                <div class="flex justify-center gap-4">
                    <button id="clear-btn" class="btn bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-8 rounded-lg text-xl">Clear</button>
                    <button id="submit-btn" class="btn bg-green-500 hover:bg-green-600 text-gray-900 font-bold py-3 px-8 rounded-lg text-xl">Submit</button>
                </div>
                
                <!-- Message Area -->
                <div id="message-area" class="text-center mt-4 h-8 text-lg text-red-400 font-semibold"></div>
            </main>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div id="upgrade-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 opacity-0 pointer-events-none transform scale-95">
        <div class="bg-gray-800 border-2 border-purple-500 rounded-2xl p-8 max-w-4xl w-full shadow-2xl text-center">
            <h2 class="font-pixel text-3xl md:text-4xl text-purple-300 mb-2">LEVEL UP!</h2>
            <p class="text-gray-300 mb-8 text-lg">Choose your upgrade!</p>
            <div id="upgrade-options" class="grid md:grid-cols-3 gap-6"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const gridContainer = document.getElementById('grid-container');
            const currentWordDisplay = document.getElementById('current-word-display');
            const scoreDisplay = document.getElementById('score');
            const levelDisplay = document.getElementById('level');
            const xpBarFill = document.getElementById('xp-bar-fill');
            const xpText = document.getElementById('xp-text');
            const messageArea = document.getElementById('message-area');
            const submitBtn = document.getElementById('submit-btn');
            const clearBtn = document.getElementById('clear-btn');
            const upgradeModal = document.getElementById('upgrade-modal');
            const upgradeOptionsContainer = document.getElementById('upgrade-options');
            const upgradesPanel = document.getElementById('upgrades-panel');
            const noUpgradesText = document.getElementById('no-upgrades-text');

            // --- Audio ---
            const synth = new Tone.Synth().toDestination();

            // --- Game State ---
            let state = {
                grid: [],
                currentWord: [],
                score: 0,
                level: 1,
                xp: 0,
                xpToNextLevel: 100,
                maxWordLength: 6,
                upgrades: [],
                isCheckingWord: false,
                goldenLetterIndex: null,
            };

            // --- Game Config ---
            const letterDistribution = 'EEEEEEEEEEEEAAAAAAAAAIIIIIIIIIOOOOOOOONNNNNNRRRRRRTTTTTTLLLLSSSSUUUUDDDDGGGBBCCMMPPFFHHVVWWYYKJXQZ';
            const letterValues = { A: 1, B: 3, C: 3, D: 2, E: 1, F: 4, G: 2, H: 4, I: 1, J: 8, K: 5, L: 1, M: 3, N: 1, O: 1, P: 3, Q: 10, R: 1, S: 1, T: 1, U: 1, V: 4, W: 4, X: 8, Y: 4, Z: 10 };
            const allUpgrades = [
                { id: 'SCORE_MULTIPLIER', title: 'Score Booster', description: 'Get 1.5x points for every word.', apply: (s) => {} },
                { id: 'LONGER_WORDS', title: 'Word Master', description: 'Allows words up to 8 characters long.', apply: (s) => { s.maxWordLength = 8; setupWordSlots(); } },
                { id: 'COMMON_LETTER_UP', title: 'Common Power', description: 'Vowels (A,E,I,O,U) are now worth 3 points.', apply: (s) => {} },
                { id: 'RARE_LETTER_UP', title: 'Rare Find', description: 'J, K, Q, X, Z are worth double points.', apply: (s) => {} },
                { id: 'XP_BOOST', title: 'Fast Learner', description: 'Gain 50% more XP from word scores.', apply: (s) => {} },
                { id: 'GRID_REFRESH', title: 'Fresh Start', description: 'Adds a button to reroll the entire grid once per level.', apply: (s) => { addRerollButton(); } }
            ];

            // --- Functions ---
            function getRandomLetter() { return letterDistribution[Math.floor(Math.random() * letterDistribution.length)]; }
            
            function setGoldenLetter() {
                const availableIndices = state.grid.map((tile, index) => !tile.selected ? index : -1).filter(index => index !== -1);
                if (availableIndices.length > 0) {
                    const randomIndex = Math.floor(Math.random() * availableIndices.length);
                    state.goldenLetterIndex = availableIndices[randomIndex];
                } else {
                    state.goldenLetterIndex = null;
                }
                renderGrid();
            }

            function setupWordSlots() {
                currentWordDisplay.innerHTML = '';
                for (let i = 0; i < state.maxWordLength; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'word-slot';
                    slot.id = `word-slot-${i}`;
                    currentWordDisplay.appendChild(slot);
                }
            }

            function createGrid() {
                state.grid = [];
                for (let i = 0; i < 25; i++) {
                    state.grid.push({ letter: getRandomLetter(), selected: false, id: i });
                }
                setGoldenLetter();
                renderGrid();
            }

            function renderGrid() {
                gridContainer.innerHTML = '';
                state.grid.forEach((tile, index) => {
                    const tileEl = document.createElement('div');
                    tileEl.className = 'letter-tile flex items-center justify-center h-16 sm:h-20 bg-gray-700 rounded-lg cursor-pointer text-3xl font-bold select-none';
                    tileEl.id = `tile-${index}`;
                    if (tile.selected) tileEl.classList.add('selected');
                    if (state.isCheckingWord) tileEl.classList.add('disabled');
                    if (index === state.goldenLetterIndex) tileEl.classList.add('golden');
                    
                    const letterSpan = document.createElement('span');
                    letterSpan.textContent = tile.letter;
                    const valueSpan = document.createElement('span');
                    valueSpan.className = 'absolute bottom-1 right-2 text-sm font-normal';
                    valueSpan.textContent = getLetterValue(tile.letter);

                    tileEl.appendChild(letterSpan);
                    tileEl.appendChild(valueSpan);
                    tileEl.addEventListener('click', () => handleTileClick(index));
                    gridContainer.appendChild(tileEl);
                });
            }
            
            function getLetterValue(letter) {
                let baseValue = letterValues[letter];
                if (state.upgrades.includes('COMMON_LETTER_UP') && 'AEIOU'.includes(letter)) return 3;
                if (state.upgrades.includes('RARE_LETTER_UP') && 'JKQXZ'.includes(letter)) return baseValue * 2;
                return baseValue;
            }

            function animateLetter(tileIndex, letter) {
                const tileEl = document.getElementById(`tile-${tileIndex}`);
                const startRect = tileEl.getBoundingClientRect();
                const wordSlotIndex = state.currentWord.length;
                const endSlot = document.getElementById(`word-slot-${wordSlotIndex}`);
                if (!endSlot) return;
                const endRect = endSlot.getBoundingClientRect();

                const flyingLetter = document.createElement('div');
                flyingLetter.className = 'flying-letter';
                flyingLetter.textContent = letter;
                flyingLetter.style.width = `${startRect.width}px`;
                flyingLetter.style.height = `${startRect.height}px`;
                flyingLetter.style.fontSize = '2rem';
                flyingLetter.style.left = `${startRect.left}px`;
                flyingLetter.style.top = `${startRect.top}px`;
                
                document.body.appendChild(flyingLetter);

                requestAnimationFrame(() => {
                    flyingLetter.style.left = `${endRect.left}px`;
                    flyingLetter.style.top = `${endRect.top}px`;
                    flyingLetter.style.width = `${endRect.width}px`;
                    flyingLetter.style.height = `${endRect.height}px`;
                    flyingLetter.style.opacity = '0';
                });

                flyingLetter.addEventListener('transitionend', () => {
                    flyingLetter.remove();
                    updateCurrentWordDisplay();
                });
            }

            function handleTileClick(index) {
                if (Tone.context.state !== 'running') Tone.start();
                if (state.isCheckingWord) return;
                
                const tile = state.grid[index];
                if (tile.selected) {
                    // Deselection logic (simplified for now, just updates state)
                    tile.selected = false;
                    state.currentWord = state.currentWord.filter(w => w.id !== tile.id);
                    renderGrid();
                    updateCurrentWordDisplay();
                } else {
                    if (state.currentWord.length < state.maxWordLength) {
                        animateLetter(index, tile.letter);
                        tile.selected = true;
                        state.currentWord.push({ ...tile, index });
                        renderGrid(); // Re-render to show selected state
                    }
                }
            }

            function updateCurrentWordDisplay() {
                const slots = document.querySelectorAll('.word-slot');
                slots.forEach((slot, i) => {
                    if (state.currentWord[i]) {
                        slot.textContent = state.currentWord[i].letter;
                        slot.classList.add('filled');
                    } else {
                        slot.textContent = '';
                        slot.classList.remove('filled');
                    }
                });
            }

            function clearSelection() {
                state.grid.forEach(tile => tile.selected = false);
                state.currentWord = [];
                renderGrid();
                updateCurrentWordDisplay();
                messageArea.textContent = '';
            }

            async function submitWord() {
                if (state.isCheckingWord) return;
                const word = state.currentWord.map(w => w.letter).join('');
                if (word.length < 3) {
                    showMessage('Word must be at least 3 letters long.', 'error');
                    return;
                }

                state.isCheckingWord = true;
                renderGrid();
                showMessage('Checking word...', 'info');

                try {
                    const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word.toLowerCase()}`);
                    if (response.ok) {
                        handleValidWord(word);
                    } else {
                        showMessage(`'${word}' is not a valid word.`, 'error');
                        clearSelection();
                    }
                } catch (error) {
                    console.error("API Error:", error);
                    showMessage('Network error. Please try again.', 'error');
                    clearSelection();
                } finally {
                    state.isCheckingWord = false;
                    renderGrid();
                }
            }
            
            function handleValidWord(word) {
                try {
                    if (Tone.context.state === 'running') {
                        const now = Tone.now();
                        synth.triggerAttackRelease("C4", "8n", now);
                        synth.triggerAttackRelease("E4", "8n", now + 0.1);
                        synth.triggerAttackRelease("G4", "8n", now + 0.2);
                    }
                } catch (e) { console.error("Could not play sound:", e); }
                
                let wordScore = 0;
                let usedGoldenLetter = state.currentWord.some(tile => tile.index === state.goldenLetterIndex);
                state.currentWord.forEach(tile => { wordScore += getLetterValue(tile.letter); });
                if (state.upgrades.includes('SCORE_MULTIPLIER')) wordScore = Math.round(wordScore * 1.5);
                
                if (usedGoldenLetter) {
                    wordScore *= 2;
                    showMessage(`Golden Word! '${word}' is valid! +${wordScore} points!`, 'success');
                } else {
                    showMessage(`'${word}' is valid! +${wordScore} points!`, 'success');
                }
                
                state.score += wordScore;
                let xpGained = wordScore;
                if (state.upgrades.includes('XP_BOOST')) xpGained = Math.round(xpGained * 1.5);
                gainXP(xpGained);
                
                state.currentWord.forEach(tile => { state.grid[tile.index] = { letter: getRandomLetter(), selected: false, id: Math.random() }; });
                if (usedGoldenLetter) state.goldenLetterIndex = null;

                clearSelection();
                updateUI();
                
                if (state.goldenLetterIndex === null) {
                    if (Math.random() < 0.1) setGoldenLetter();
                }
            }

            function gainXP(amount) {
                state.xp += amount;
                if (state.xp >= state.xpToNextLevel) levelUp();
                updateUI();
            }

            function levelUp() {
                state.level++;
                state.xp -= state.xpToNextLevel;
                state.xpToNextLevel = Math.floor(state.xpToNextLevel * 1.5);
                showMessage(`LEVEL UP! You are now level ${state.level}!`, 'levelup');
                
                const rerollBtn = document.getElementById('reroll-btn');
                if (rerollBtn) rerollBtn.remove();
                if (state.upgrades.includes('GRID_REFRESH')) addRerollButton();
                
                showUpgradeModal();
            }
            
            function showUpgradeModal() {
                const availableUpgrades = allUpgrades.filter(u => !state.upgrades.includes(u.id));
                let chosenUpgrades = [];
                while (chosenUpgrades.length < 3 && availableUpgrades.length > 0) {
                    const randomIndex = Math.floor(Math.random() * availableUpgrades.length);
                    chosenUpgrades.push(availableUpgrades.splice(randomIndex, 1)[0]);
                }

                upgradeOptionsContainer.innerHTML = '';
                chosenUpgrades.forEach(upgrade => {
                    const card = document.createElement('div');
                    card.className = 'upgrade-card bg-gray-700 p-6 rounded-lg cursor-pointer text-left';
                    card.innerHTML = `<h3 class="font-pixel text-xl text-yellow-300 mb-2">${upgrade.title}</h3><p class="text-gray-300">${upgrade.description}</p>`;
                    card.addEventListener('click', () => selectUpgrade(upgrade));
                    upgradeOptionsContainer.appendChild(card);
                });

                upgradeModal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
            }
            
            function selectUpgrade(upgrade) {
                if (noUpgradesText) {
                    noUpgradesText.style.display = 'none';
                }

                state.upgrades.push(upgrade.id);
                upgrade.apply(state);
                
                const upgradeCard = document.createElement('div');
                upgradeCard.className = 'upgrade-info-card';
                upgradeCard.innerHTML = `
                    <h4 class="font-pixel text-lg text-yellow-300 mb-2">${upgrade.title}</h4>
                    <p class="text-gray-300 text-sm">${upgrade.description}</p>
                `;
                upgradesPanel.appendChild(upgradeCard);

                upgradeModal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                updateUI();
                renderGrid();
            }
            
            function addRerollButton() {
                if (document.getElementById('reroll-btn')) return;
                const rerollBtn = document.createElement('button');
                rerollBtn.id = 'reroll-btn';
                rerollBtn.className = 'btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-xl';
                rerollBtn.textContent = 'Reroll Grid';
                rerollBtn.addEventListener('click', () => { createGrid(); clearSelection(); rerollBtn.remove(); });
                document.querySelector('.flex.justify-center.gap-4').appendChild(rerollBtn);
            }

            function showMessage(msg, type) {
                messageArea.textContent = msg;
                messageArea.className = 'text-center mt-4 h-8 text-lg font-semibold';
                switch (type) {
                    case 'error': messageArea.classList.add('text-red-400'); break;
                    case 'success': messageArea.classList.add('text-green-400'); break;
                    case 'info': messageArea.classList.add('text-blue-300'); break;
                    case 'levelup': messageArea.classList.add('text-yellow-300', 'font-pixel'); break;
                }
            }

            function updateUI() {
                scoreDisplay.textContent = state.score;
                levelDisplay.textContent = state.level;
                const xpPercentage = Math.min(100, (state.xp / state.xpToNextLevel) * 100);
                xpBarFill.style.width = `${xpPercentage}%`;
                xpText.textContent = `${state.xp} / ${state.xpToNextLevel}`;
            }

            // --- Event Listeners ---
            submitBtn.addEventListener('click', submitWord);
            clearBtn.addEventListener('click', clearSelection);

            // --- Initialisation ---
            function init() {
                setupWordSlots();
                createGrid();
                updateUI();
            }

            init();
        });
    </script>
</body>
</html>
