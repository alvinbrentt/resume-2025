<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Birthday Song Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .spotify-green {
            background-color: #1DB954;
        }
        .spotify-green:hover {
            background-color: #1ED760;
        }
        .spotify-dark {
            background-color: #191414;
        }
        .card-enter {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .card-enter-active {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">Birthday Jams</h1>
            <p class="text-gray-400 text-lg">Find songs released on your birthday!</p>
        </header>

        <!-- Login View -->
        <div id="login-view" class="max-w-md mx-auto text-center p-8 bg-gray-800 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4">Discover Your Birthday Jams</h2>
            <p class="text-gray-400 mb-6">Login with your Spotify account to find songs released on your birthday.</p>
            <button id="login-button" class="w-full spotify-green text-white font-bold py-3 px-4 rounded-lg transition duration-300 transform hover:scale-105">
                Login with Spotify
            </button>
        </div>

        <!-- Main App View -->
        <div id="main-view" class="hidden">
            <div id="user-greeting" class="text-center text-lg text-gray-300 mb-4"></div>
            <div class="max-w-md mx-auto text-center mb-8">
                <label for="birthday" class="block text-lg font-medium text-gray-300 mb-2">Select a date to search:</label>
                <input type="date" id="birthday" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-spotify-green" style="color-scheme: dark;">
                <button id="find-songs-button" class="mt-4 w-full spotify-green text-white font-bold py-3 px-4 rounded-lg transition duration-300 transform hover:scale-105">
                    Find Jams For This Date
                </button>
            </div>

            <!-- Loading Indicator -->
            <div id="loading" class="hidden text-center my-8">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-spotify-green"></div>
                <p class="mt-4 text-lg text-gray-400">Searching the archives... this might take a moment!</p>
            </div>

            <!-- Results -->
            <div id="results-container">
                <h2 id="results-title" class="text-3xl font-bold text-center mb-8 hidden"></h2>
                <div id="results" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                    <!-- Song cards will be injected here -->
                </div>
                 <div id="no-results" class="hidden text-center py-12">
                    <p class="text-xl text-gray-400">No songs found for that date. Try another one!</p>
                </div>
            </div>
        </div>

        <!-- Modal for alerts -->
        <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-gray-800 rounded-lg p-8 shadow-lg max-w-sm w-full mx-4 text-center">
                <p id="alert-message" class="text-white text-lg mb-6"></p>
                <button id="alert-close-button" class="w-full bg-spotify-green text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105">OK</button>
            </div>
        </div>

    </div>

    <script>
        // Hardcoded Client ID
        const CLIENT_ID = '54b241c19fc24d39b1859214c3bc31b5';

        const loginButton = document.getElementById('login-button');
        const findSongsButton = document.getElementById('find-songs-button');
        const birthdayInput = document.getElementById('birthday');
        const loginView = document.getElementById('login-view');
        const mainView = document.getElementById('main-view');
        const userGreeting = document.getElementById('user-greeting');
        const loading = document.getElementById('loading');
        const resultsContainer = document.getElementById('results');
        const resultsTitle = document.getElementById('results-title');
        const noResults = document.getElementById('no-results');
        const alertModal = document.getElementById('alert-modal');
        const alertMessage = document.getElementById('alert-message');
        const alertCloseButton = document.getElementById('alert-close-button');

        let accessToken = '';

        // Function to show custom alert modal
        function customAlert(message) {
            alertMessage.textContent = message;
            alertModal.classList.remove('hidden');
        }

        // Event listener to close the modal
        alertCloseButton.addEventListener('click', () => {
            alertModal.classList.add('hidden');
        });

        // On page load, check for access token in URL hash
        window.addEventListener('load', () => {
            const hash = window.location.hash;
            if (hash) {
                const params = new URLSearchParams(hash.substring(1));
                const token = params.get('access_token');
                if (token) {
                    accessToken = token;
                    // Clean the URL
                    window.history.pushState("", document.title, window.location.pathname + window.location.search);
                    initializeMainView();
                }
            }
        });

        loginButton.addEventListener('click', () => {
            redirectToSpotifyLogin();
        });

        function redirectToSpotifyLogin() {
            const redirectUri = window.location.href.split('#')[0];
            // REMOVED 'user-read-birthdate' from scope to fix error
            const scope = 'user-read-private user-read-email';
            let url = 'https://accounts.spotify.com/authorize';
            url += '?response_type=token';
            url += '&client_id=' + encodeURIComponent(CLIENT_ID);
            url += '&scope=' + encodeURIComponent(scope);
            url += '&redirect_uri=' + encodeURIComponent(redirectUri);
            window.location = url;
        }
        
        async function initializeMainView() {
            loginView.classList.add('hidden');
            mainView.classList.remove('hidden');
            
            // Set a default date to today to avoid empty input
            const today = new Date().toISOString().split('T')[0];
            birthdayInput.value = today;

            try {
                const profile = await fetchUserProfile();
                userGreeting.textContent = `Welcome, ${profile.display_name}!`;
            } catch (error) {
                 console.error('Error fetching profile:', error);
                 userGreeting.textContent = 'Welcome! Please select a date to begin.';
            }
        }

        async function fetchUserProfile() {
            const response = await fetch('https://api.spotify.com/v1/me', {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            if (!response.ok) {
                throw new Error('Failed to fetch user profile');
            }
            return await response.json();
        }

        findSongsButton.addEventListener('click', () => {
             const birthDate = birthdayInput.value;
             if (!birthDate) {
                 customAlert('Please select a date.'); // REPLACED ALERT
                 return;
             }
             performSearch(birthDate);
        });

        async function performSearch(date) {
            loading.classList.remove('hidden');
            resultsContainer.innerHTML = '';
            resultsTitle.classList.add('hidden');
            noResults.classList.add('hidden');

            const [year, month, day] = date.split('-');
            const searchDate = `${month}-${day}`;

            try {
                const songs = await findSongsForDate(searchDate);
                displayResults(songs, searchDate);
            } catch (error) {
                console.error('Error finding songs:', error);
                customAlert('An error occurred. Your session might have expired. Please try logging in again.'); // REPLACED ALERT
                // Clear token and show login view
                accessToken = '';
                loginView.classList.remove('hidden');
                mainView.classList.add('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        }

        async function findSongsForDate(searchDate) {
            const [month, day] = searchDate.split('-');
            const allSongs = new Map(); // Use a map to avoid duplicate tracks
            const currentYear = new Date().getFullYear();
            const yearsToSearch = Array.from({ length: 75 }, (_, i) => currentYear - i); // Search last 75 years

            // Create batches of promises to avoid overwhelming the browser/API
            const batchSize = 10;
            const songResults = [];

            for (let i = 0; i < yearsToSearch.length; i += batchSize) {
                const batch = yearsToSearch.slice(i, i + batchSize);
                const fetchPromises = batch.map(year => {
                    const query = `year:${year}`;
                    const url = `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=50&market=US`;
                    
                    return fetch(url, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    }).then(response => {
                        if (response.status === 401) throw new Error('Unauthorized');
                        if (!response.ok) return null;
                        return response.json();
                    });
                });
                
                const results = await Promise.allSettled(fetchPromises);
                songResults.push(...results);
            }


            songResults.forEach(result => {
                if (result.status === 'fulfilled' && result.value) {
                    const tracks = result.value.tracks.items;
                    tracks.forEach(track => {
                        // Check for exact date match and that the album has a full release date
                        if (track.album.release_date_precision === 'day' && track.album.release_date.endsWith(searchDate)) {
                            if (!allSongs.has(track.id)) { // Check for duplicates
                                allSongs.set(track.id, {
                                    id: track.id,
                                    name: track.name,
                                    artist: track.artists.map(a => a.name).join(', '),
                                    albumArt: track.album.images.length > 0 ? track.album.images[0].url : 'https://placehold.co/300x300/191414/1DB954?text=No+Art',
                                    url: track.external_urls.spotify,
                                    releaseYear: track.album.release_date.substring(0, 4)
                                });
                            }
                        }
                    });
                } else if (result.status === 'rejected') {
                    throw result.reason;
                }
            });
            
            // Sort songs by year, newest first
            return Array.from(allSongs.values()).sort((a, b) => b.releaseYear - a.releaseYear);
        }

        function displayResults(songs, searchDate) {
            resultsContainer.innerHTML = ''; // Clear previous results
            const [month, day] = searchDate.split('-');
            const formattedDate = new Date(2000, month - 1, day).toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
            
            if (songs.length > 0) {
                resultsTitle.textContent = `Songs Released on ${formattedDate}`;
                resultsTitle.classList.remove('hidden');

                songs.forEach((song, index) => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 rounded-lg overflow-hidden shadow-lg transform hover:-translate-y-1 transition-all duration-300 card-enter';
                    card.style.transitionDelay = `${index * 50}ms`;
                    card.innerHTML = `
                        <a href="${song.url}" target="_blank" rel="noopener noreferrer">
                            <img src="${song.albumArt}" alt="Album art for ${song.name}" class="w-full h-auto object-cover aspect-square" onerror="this.onerror=null;this.src='https://placehold.co/300x300/191414/1DB954?text=No+Art';">
                            <div class="p-4">
                                <h3 class="font-bold text-lg truncate text-white">${song.name}</h3>
                                <p class="text-gray-400 truncate">${song.artist}</p>
                                <p class="text-sm text-spotify-green font-semibold mt-1">${song.releaseYear}</p>
                            </div>
                        </a>
                    `;
                    resultsContainer.appendChild(card);
                    // Trigger animation
                    requestAnimationFrame(() => {
                        card.classList.add('card-enter-active');
                    });
                });
            } else {
                noResults.classList.remove('hidden');
                resultsTitle.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
